{"title":"Audit Service","description":"[[suggested_dashboards]]","widgets":[{"id":3076461365042461,"definition":{"title":"Report export","show_title":true,"type":"group","layout_type":"ordered","widgets":[{"id":5349366660411358,"definition":{"title":"Report creation status","title_size":"16","title_align":"left","show_legend":true,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"formulas":[{"formula":"query1"}],"queries":[{"name":"query1","data_source":"metrics","query":"avg:audit.events.report.status{*} by {status}.as_count()"}],"response_format":"timeseries","style":{"palette":"semantic","order_by":"values","line_type":"solid","line_width":"normal"},"display_type":"bars"}]},"layout":{"x":0,"y":0,"width":4,"height":2}},{"id":3027787654688980,"definition":{"title":"Average page query time from MongoDB","title_size":"16","title_align":"left","show_legend":true,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"response_format":"timeseries","queries":[{"data_source":"metrics","name":"query1","query":"avg:audit.report.export.page.query.time.avg{*} by {page_size_bucket,event_type}"}],"formulas":[{"formula":"query1"}],"style":{"palette":"dog_classic","order_by":"values","line_type":"solid","line_width":"normal"},"display_type":"line"}]},"layout":{"x":4,"y":0,"width":4,"height":2}},{"id":2119982673461337,"definition":{"title":"Number of pages retrieved from MongoDB","title_size":"16","title_align":"left","show_legend":true,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"response_format":"timeseries","queries":[{"data_source":"metrics","name":"query1","query":"avg:audit.report.export.pages.count{*} by {event_type,page_size_bucket}.as_count()"}],"formulas":[{"formula":"query1"}],"style":{"palette":"dog_classic","order_by":"values","line_type":"solid","line_width":"normal"},"display_type":"line"}]},"layout":{"x":8,"y":0,"width":4,"height":2}}]},"layout":{"x":0,"y":0,"width":12,"height":1}},{"id":4707971429048937,"definition":{"title":"SNS & SQS","show_title":true,"type":"group","layout_type":"ordered","widgets":[{"id":7120156420941238,"definition":{"title":"SNS message published to audit-events","title_size":"16","title_align":"left","show_legend":true,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"formulas":[{"formula":"query1"}],"queries":[{"name":"query1","data_source":"metrics","query":"sum:aws.sns.number_of_messages_published{topicname:hibob-prod-eu-west-1-audit-event}.as_count()"}],"response_format":"timeseries","style":{"palette":"dog_classic","order_by":"values","line_type":"solid","line_width":"normal"},"display_type":"line"}]},"layout":{"x":0,"y":0,"width":4,"height":2}},{"id":1128262539194772,"definition":{"title":"Consumed events by status","title_size":"16","title_align":"left","show_legend":true,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"formulas":[{"formula":"query1"}],"queries":[{"name":"query1","data_source":"metrics","query":"avg:audit.events.publish{*} by {status,source}.as_count()"}],"response_format":"timeseries","style":{"palette":"semantic","order_by":"values","line_type":"solid","line_width":"normal"},"display_type":"line"}]},"layout":{"x":4,"y":0,"width":4,"height":2}},{"id":1106717348639862,"definition":{"title":"Fetch events status TODO change metric","title_size":"16","title_align":"left","show_legend":true,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"formulas":[{"formula":"query1"}],"queries":[{"name":"query1","data_source":"metrics","query":"avg:audit.events.publish{*} by {status}.as_count()"}],"response_format":"timeseries","style":{"palette":"semantic","order_by":"values","line_type":"solid","line_width":"normal"},"display_type":"line"}]},"layout":{"x":8,"y":0,"width":4,"height":2}},{"id":4397318482431624,"definition":{"title":"Average consumption time for a single message without processing","title_size":"16","title_align":"left","show_legend":true,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"formulas":[{"formula":"query1"}],"queries":[{"name":"query1","data_source":"metrics","query":"avg:audit.events.consume.avg{*}"}],"response_format":"timeseries","style":{"palette":"dog_classic","order_by":"values","line_type":"solid","line_width":"normal"},"display_type":"line"}]},"layout":{"x":0,"y":2,"width":4,"height":2}},{"id":3461380758008308,"definition":{"title":"Age of oldest message in audit-events SQS","title_size":"16","title_align":"left","show_legend":true,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"formulas":[{"alias":"current","formula":"query1"}],"queries":[{"name":"query1","data_source":"metrics","query":"avg:aws.sqs.approximate_age_of_oldest_message{queuename:audit-events-prod}"}],"response_format":"timeseries","style":{"palette":"dog_classic","order_by":"values","line_type":"solid","line_width":"normal"},"display_type":"line"},{"response_format":"timeseries","queries":[{"data_source":"metrics","name":"query0","query":"avg:aws.sqs.approximate_age_of_oldest_message{queuename:audit-events-prod}"}],"formulas":[{"alias":"previous week","formula":"calendar_shift(query0, '-1w', 'Europe/Bucharest')"}],"style":{"palette":"dog_classic","line_type":"dashed","line_width":"normal"},"display_type":"line"}]},"layout":{"x":4,"y":2,"width":4,"height":2}},{"id":134766517751998,"definition":{"title":"Mongo % time spent","title_size":"16","title_align":"left","show_legend":false,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"formulas":[{"formula":"ewma_10(query1 * 100 / query2)"}],"queries":[{"data_source":"metrics","name":"query1","query":"sum:trace.akka_http.request.exec_time.by_service{env:prod,service:hibob-api, sublayer_service:mongo, sublayer_inferred:peer.db.name:audit} by {sublayer_service,sublayer_inferred}.rollup(sum).fill(zero)"},{"data_source":"metrics","name":"query2","query":"sum:trace.akka_http.request.exec_time.by_service{env:prod,service:hibob-api}.rollup(sum).fill(zero)"}],"response_format":"timeseries","style":{"palette":"dog_classic","line_type":"solid","line_width":"normal"},"display_type":"area"}],"yaxis":{"max":"100"}},"layout":{"x":8,"y":2,"width":4,"height":2}},{"id":5534474341028064,"definition":{"title":"Consume and write batch duration p95","title_size":"16","title_align":"left","show_legend":true,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"formulas":[{"formula":"query1"}],"queries":[{"name":"query1","data_source":"metrics","query":"avg:audit.events.consumebatched.95percentile{*}"}],"response_format":"timeseries","style":{"palette":"dog_classic","order_by":"values","line_type":"solid","line_width":"normal"},"display_type":"line"}]},"layout":{"x":0,"y":4,"width":4,"height":2}},{"id":2925168968481648,"definition":{"title":"Visible events in audit-events SQS","title_size":"16","title_align":"left","show_legend":true,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"formulas":[{"alias":"current","formula":"query1"}],"queries":[{"name":"query1","data_source":"metrics","query":"avg:aws.sqs.approximate_number_of_messages_visible{queuename:audit-events-prod}"}],"response_format":"timeseries","style":{"palette":"dog_classic","order_by":"values","line_type":"solid","line_width":"normal"},"display_type":"line"},{"response_format":"timeseries","queries":[{"data_source":"metrics","name":"query0","query":"avg:aws.sqs.approximate_number_of_messages_visible{queuename:audit-events-prod, aws_account:242867168342}"}],"formulas":[{"alias":"previous week","formula":"calendar_shift(query0, '-1w', 'Europe/Bucharest')"}],"style":{"palette":"dog_classic","line_type":"dashed","line_width":"normal"},"display_type":"line"}]},"layout":{"x":4,"y":4,"width":4,"height":2}}]},"layout":{"x":0,"y":1,"width":12,"height":1}},{"id":395065001843054,"definition":{"title":"Errors","title_size":"16","title_align":"left","requests":[{"response_format":"event_list","query":{"data_source":"logs_stream","query_string":"service:audit status:error -\"using default policy\"","indexes":[],"storage":"hot"},"columns":[{"field":"status_line","width":"auto"},{"field":"timestamp","width":"auto"},{"field":"host","width":"auto"},{"field":"service","width":"auto"},{"field":"content","width":"auto"}]}],"type":"list_stream"},"layout":{"x":0,"y":0,"width":8,"height":4}},{"id":4707939659461844,"definition":{"title":"Audit Postgres DB size","title_size":"16","title_align":"left","show_legend":false,"type":"timeseries","requests":[{"formulas":[{"formula":"query1"}],"queries":[{"data_source":"metrics","name":"query1","query":"avg:postgresql.database_size{db:audit}"}],"response_format":"timeseries","style":{"palette":"dog_classic","order_by":"values","line_type":"solid","line_width":"normal"},"display_type":"line"}]},"layout":{"x":8,"y":0,"width":4,"height":4}},{"id":9000000000000000,"definition":{"title":"Data ingestion speed (kafka)","show_title":true,"type":"group","layout_type":"ordered","widgets":[{"id":9000000000000001,"definition":{"title":"Average Processing Time","title_size":"16","title_align":"left","show_legend":true,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"formulas":[{"formula":"query1"}],"queries":[{"name":"query1","data_source":"metrics","query":"avg:kafka.subscriber.bulk.processing.time.avg{topic:audit.public-api-audit.v1} by {group.id}"}],"response_format":"timeseries","style":{"palette":"dog_classic","order_by":"values","line_type":"solid","line_width":"normal"},"display_type":"line"}]},"layout":{"x":0,"y":0,"width":4,"height":2}},{"id":9000000000000002,"definition":{"title":"Processing Time P95","title_size":"16","title_align":"left","show_legend":true,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"formulas":[{"formula":"query1"}],"queries":[{"name":"query1","data_source":"metrics","query":"avg:kafka.subscriber.bulk.processing.time.95percentile{topic:audit.public-api-audit.v1} by {group.id}"}],"response_format":"timeseries","style":{"palette":"dog_classic","order_by":"values","line_type":"solid","line_width":"normal"},"display_type":"line"}]},"layout":{"x":4,"y":0,"width":4,"height":2}},{"id":9000000000000003,"definition":{"title":"Processing Time P99","title_size":"16","title_align":"left","show_legend":true,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"formulas":[{"formula":"query1"}],"queries":[{"name":"query1","data_source":"metrics","query":"avg:kafka.subscriber.bulk.processing.time.99percentile{topic:audit.public-api-audit.v1} by {group.id}"}],"response_format":"timeseries","style":{"palette":"dog_classic","order_by":"values","line_type":"solid","line_width":"normal"},"display_type":"line"}]},"layout":{"x":8,"y":0,"width":4,"height":2}},{"id":9000000000000004,"definition":{"title":"Processing Time Max","title_size":"16","title_align":"left","show_legend":true,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"formulas":[{"formula":"query1"}],"queries":[{"name":"query1","data_source":"metrics","query":"avg:kafka.subscriber.bulk.processing.time.max{topic:audit.public-api-audit.v1} by {group.id}"}],"response_format":"timeseries","style":{"palette":"dog_classic","order_by":"values","line_type":"solid","line_width":"normal"},"display_type":"line"}]},"layout":{"x":0,"y":2,"width":4,"height":2}},{"id":9000000000000005,"definition":{"title":"Bulk Size","title_size":"16","title_align":"left","show_legend":true,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"formulas":[{"formula":"query1"}],"queries":[{"name":"query1","data_source":"metrics","query":"avg:kafka.subscriber.bulk.size.avg{topic:audit.public-api-audit.v1} by {group.id}"}],"response_format":"timeseries","style":{"palette":"dog_classic","order_by":"values","line_type":"solid","line_width":"normal"},"display_type":"line"}]},"layout":{"x":4,"y":2,"width":4,"height":2}},{"id":9000000000000006,"definition":{"title":"Bulk Processing Rate (bulks/sec)","title_size":"16","title_align":"left","show_legend":true,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"formulas":[{"formula":"query1"}],"queries":[{"name":"query1","data_source":"metrics","query":"sum:kafka.subscriber.bulk.processing.time.count{topic:audit.public-api-audit.v1} by {group.id}.as_count()"}],"response_format":"timeseries","style":{"palette":"dog_classic","order_by":"values","line_type":"solid","line_width":"normal"},"display_type":"line"}]},"layout":{"x":8,"y":2,"width":4,"height":2}}]},"layout":{"x":0,"y":6,"width":12,"height":5}},{"id":8127471388060644,"definition":{"title":"Deleting old data","show_title":true,"type":"group","layout_type":"ordered","widgets":[{"id":4277377749134646,"definition":{"title":"Average batch removal duration","title_size":"16","title_align":"left","show_legend":true,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"response_format":"timeseries","queries":[{"data_source":"metrics","name":"query1","query":"avg:audit.public_api_call_record.delete.batch_duration.avg{*}"}],"formulas":[{"formula":"query1"}],"style":{"palette":"dog_classic","order_by":"values","line_type":"solid","line_width":"normal"},"display_type":"line"}]},"layout":{"x":0,"y":0,"width":6,"height":3}},{"id":1998505580119721,"definition":{"title":"Average removal job duration","title_size":"16","title_align":"left","show_legend":true,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"response_format":"timeseries","queries":[{"data_source":"metrics","name":"query1","query":"avg:audit.public_api_call_record.delete.job_duration.avg{*}"}],"formulas":[{"formula":"query1"}],"style":{"palette":"dog_classic","order_by":"values","line_type":"solid","line_width":"normal"},"display_type":"line"}]},"layout":{"x":6,"y":0,"width":6,"height":3}},{"id":3141612852578202,"definition":{"title":"Batches deleted per job ","title_size":"16","title_align":"left","show_legend":true,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"response_format":"timeseries","queries":[{"data_source":"metrics","name":"query1","query":"avg:audit.public_api_call_record.delete.batch_count{*}.as_count()"}],"formulas":[{"formula":"query1"}],"style":{"palette":"dog_classic","order_by":"values","line_type":"solid","line_width":"normal"},"display_type":"line"}]},"layout":{"x":0,"y":3,"width":6,"height":3}},{"id":769447677943968,"definition":{"title":"Records deleted per batch","title_size":"16","title_align":"left","show_legend":true,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"response_format":"timeseries","queries":[{"data_source":"metrics","name":"query1","query":"audit.public_api_call_record.delete.batch_deleted_count{*}.as_count()"}],"formulas":[{"formula":"query1"}],"style":{"palette":"dog_classic","order_by":"values","line_type":"solid","line_width":"normal"},"display_type":"line"}]},"layout":{"x":6,"y":3,"width":6,"height":3}}]},"layout":{"x":0,"y":11,"width":12,"height":7}},{"id":3443774945304485,"definition":{"title":"Resource usage","background_color":"purple","show_title":true,"powerpack_id":"50dbb12a-c818-11ed-a984-da7ad0900005","template_variables":{"controlled_externally":[],"controlled_by_powerpack":[{"name":"kube_namespace","prefix":"kube_namespace","values":["production"]},{"name":"kube_deployment","prefix":"kube_deployment","values":["audit"]}]},"type":"powerpack"},"layout":{"x":0,"y":0,"width":12,"height":9,"is_column_break":true}},{"id":3732939892437050,"definition":{"title":"Kafka Lag","background_color":"vivid_orange","show_title":true,"powerpack_id":"02a5c08a-34b4-11f0-8eb6-da7ad0900005","template_variables":{"controlled_externally":[],"controlled_by_powerpack":[{"name":"cluster","prefix":"cluster_name","values":["hibob-prod-eu-west-1-msk"]},{"name":"topic","prefix":"topic","values":["audit.public-api-audit.v1"]}]},"type":"powerpack"},"layout":{"x":0,"y":9,"width":12,"height":6}},{"id":7906431855037121,"definition":{"title":"Kafka Throughput","background_color":"vivid_orange","show_title":true,"powerpack_id":"b56f52e8-34b0-11f0-a297-da7ad0900005","template_variables":{"controlled_externally":[],"controlled_by_powerpack":[{"name":"cluster","prefix":"cluster_name","values":["hibob-prod-eu-west-1-msk"]},{"name":"topic","prefix":"topic","values":["audit.public-api-audit.v1"]}]},"type":"powerpack"},"layout":{"x":0,"y":15,"width":12,"height":7}}],"template_variables":[],"layout_type":"ordered","notify_list":[],"pause_auto_refresh":false,"reflow_type":"fixed"}